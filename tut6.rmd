---
title: 'Tutorial 6: Volatility and Correlation'
output:
  html_document: default
  html_notebook: default
---

##Learning Outcomes:

At the end of today's tutorial you should be able to do the following:

-Calculate volatility 

-Construct a covariance matrix

-Calculate the confidence intervals for a variance estimate
```{r}
getwd()
```
###Example 1: Variance and Volatility

We apply volatility to measure the risk of the returns on an investment and an important note is that volatility is greater when there is positive serial correlation between returns than it is when returns are i.i.d.

Assuming that returns are generated by an i.i.d. process:

(a) The variance of daily returns is 0.002. Assume 250 risk days per year, what is the volatility?

```{r}
#Why do we use 250?
volatility<-sqrt(0.001*250)
volatility
```

(b) Given that the volatility is 36%. What is the standard deviation of weekly returns?

```{r}
#Why do we use 52?
stdev<-0.36/sqrt(52)
stdev
```

###Example 2: Covariance and Correlation

Covariance is used to estimate the volatility of a portfolio as well as simulate vaules for risk factors.

Our covariance matrix, $V$, is an n X n  matrix with the variances on the diagonal. 

The matrix $V$ is equal to $DCD$, where $D$ is the n X n diagonal matrix with standard deviations and $C$ is n X n correlation matrix

Lastly, we have that the variance of a portfolio with weights vectot $w$ is $w'Vw$.

From this, we can construct the covariance matrix from the following information:

Assume that we have a portfolio with three assets with the following weights: $w = (\dfrac{1}{6},\dfrac{2}{6},\dfrac{3}{6})$

In this example, we will also assume the volatilities (20%,10%,15%) and the following correlations:

-asset 1 with asset 2: 0.8

-asset 2 with asset 3: 0.3

-asset 3 with asset 1: 0.5


The first step will be to construct the covariance matrix $V$

```{r}
#correlations
corr12=0.8
corr23=0.3
corr31=0.5

#volatilities
v1=0.2
v2=0.1
v3=0.15

#Covariance Matrix
D = diag(c(v1,v2,v3),nrow = 3,ncol = 3)
C = matrix(c(1,corr12,corr31,corr12,1,corr23,corr31,corr23,1), nrow=3, ncol=3)
V = D%*%C%*%D
V
```

Now we have our covariance matrix $V$. The variance of a portfolio with weights $w$ is calculated as $w'Vw$, which we will do next:

```{r}
w1 = 1/6
w2 = 2/6
w3 = 3/6

w = matrix(c(w1,w2,w3), nrow=3, ncol=1)

#the function t() transposes a matrix
Portv = t(w)%*%V%*%w
Portv
```
Taking the square root of the annual variance gives the portfolio volatility:

```{r}
portvol = sqrt(Portv)
portvol
```
This example shows that the covariance matrix is all that we need to measure the volatility of the returns on a linear portfolio, assuming we know the amount invested in each asset.

###Example 3: Equally Weighted Average Estimate of FTSE 100 and S&P 500 Volatility 

Download the following datasets [FSTE Data](https://www.dropbox.com/s/5wf7zmgc7m2fsoh/FTSE100.csv?dl=0) and [S&P 500 Data](https://www.dropbox.com/s/5wf7exy2e0lm3s47b12/SP500.csv?dl=0) and save them in your working directory, then read into your RMD file for the tutorial.
```{r}
ftse<-read.csv("FTSE100.csv")
sp500<-read.csv("SP500.csv")

#Calculating the log returns
lretsftse <-diff(log(ftse$FTSE))
lretssp <-diff(log(sp500$S.P.500))
```

The first step is to calculate the daily log returns:
```{r}
#Why do we use log returns?
lretsftse <-diff(log(ftse$FTSE))
lretssp <-diff(log(sp500$S.P.500))
lretsftse
lretssp
```

Step two is to square the log returns:
```{r}
lretssftse<-lretsftse^2
lretsssp<-lretssp^2
```
Step three is to take the average (we calculate the average by dividing the sum of the squared returns by 10):
```{r}
lretsavftse<-sum(lretssftse[1:10])/10
lretsavsp<-sum(lretsssp[1:10])/10
lretsavftse
lretsavsp
```

The next step is to take the square root of this and multiply it by the annualizing factor, which is assumed to be $\sqrt{250}$ since the returns are daily.

Now we can calculate the volatility:
```{r}
lretsvolftse<-sqrt(250*lretsavftse)*100
lretsvolsp<-sqrt(250*lretsavsp)*100
lretsvolftse
lretsvolsp
```
The equally weighted unconditional covariance matrix estimate at time t for a set of n returns is denoted $\hat{V}_{t} = (\hat{\sigma}_{ijt})$ for $i,j=1,.....,n$, where each $\hat{\sigma_{ijt}}$ is given by :
$\hat{\sigma}_{ijt} = T^{-1}\sum_{k=1}^{T}r_{i,t-k}r_{j,t-k}$.

The covariance matrix estimate for the FTSE 100 and S&P 500 returns is given by:
```{r}
#Calculating the covariance matrix estimate for FTSE 100 and S&P 500
covftsesp<-(sum(lretsftse[1:10]*lretssp[1:10]))/10
covmat = matrix(c(lretsavftse,covftsesp,covftsesp,lretsavsp), nrow=2, ncol=2)
covmat
```

###Example 4: Confidence Interval for a Variance Estimate

We assume that the daily log returns on the FTSE 100 are normally distributed. Using the sample from Example 2 we will construct a 95% confidence interval for the variance of the returns.

Step 1: we need to recall how many returns we used, which is $T$ and use the following critical values: $\chi_{0.025,10}^2 = 20.483$ and $\chi_{0.975,10}^2 = 3.247$

Recall the variance estimate $\hat{\sigma}^2$ from Example 2.

Step 2: we need to calculate the confidence interval from the following:

$(\dfrac{T\hat{\sigma}^2}{\chi_{\alpha/2,T}^2},\dfrac{T\hat{\sigma}^2}{\chi_{1-\alpha/2,T}^2})$

Therefore the confidence interval is given by:

```{r}
CIlowftse<- (10*lretsavftse)/20.483
CIupftse<- (10*lretsavftse)/3.247
CIlowftse
CIupftse
```

```{r}
CIlowsp<- (10*lretsavsp)/20.483
CIupsp<- (10*lretsavsp)/3.247
CIlowsp
CIupsp
```
###Exercise 1: Variance and Volatility

Instead of i.i.d. generated returns, we assume autocorrelation in the returns, e.g.autorcorrelation of one lag: AR(1):

$r_{t} = \alpha + \rho r_{t-1}+ \varepsilon_{t}$ where $\rho$ is the autocorrelation parameter between adjacent returns.

Due to the autocorrelation, the scaling factor is not $\sqrt{h}$ but it is:

$\sqrt{h + 2\dfrac{\rho}{(1-\rho)^2}[(h-1)(1-\rho) - \rho(1-\rho^{h-1})]}$

Therefore, if the monthly returns of a hedge fund over the past three years are 5% and returns are i.i.d. 

The volatility estimate is given by:

$\hat{\sigma} = 0.05*\sqrt{12} = 0.1732$

Supposing a smoothing has taken place with $\rho = 0.25$ i.e. returns are not generated by an i.i.d process then the scaling factor is given by the formula above (due to autocorrelation). 

Calculate the new volatility estimate and compare it to the volatility estimate of 17.32%.

###Exercise 2: Covariance and Correlation

Assume that we have a portfolio with three assets with the following weights: $w = (\dfrac{1}{4},\dfrac{1}{4},\dfrac{2}{4})$

In this example, we will also assume the volatilities (10%,10%,25%) and the following correlations:

-asset 1 with asset 2: 0.7

-asset 2 with asset 3: 0.5

-asset 3 with asset 1: 0.2

(a) Construct the covariance matrix for the above portfolio.

(b) Calculate the portfolio variance estimate.

###Exercise 3: Confidence Intervals for a Variance Estimate and Volatility

(a) Compute the confidence interval for the S&P 500 variance estimate.

(b) Using the results from Example 3, calculate the confidence interval for the volatility of both the FTSE 100 and the S&P 500
